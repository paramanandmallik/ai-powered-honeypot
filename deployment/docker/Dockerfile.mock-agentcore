FROM python:3.11-slim

WORKDIR /app

# Install system dependencies and development tools
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    curl \
    wget \
    git \
    vim \
    htop \
    net-tools \
    telnet \
    netcat-openbsd \
    jq \
    redis-tools \
    postgresql-client \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements and install Python dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Install additional development dependencies for AgentCore simulation
RUN pip install --no-cache-dir \
    pytest \
    pytest-asyncio \
    pytest-cov \
    black \
    flake8 \
    mypy \
    requests \
    aiohttp \
    uvicorn[standard] \
    fastapi \
    pydantic \
    redis \
    psycopg2-binary \
    pika \
    websockets \
    prometheus-client

# Copy application code
COPY agents/ ./agents/
COPY config/ ./config/
COPY deployment/mock-agentcore/ ./mock-agentcore/

# Create comprehensive directory structure for AgentCore simulation
RUN mkdir -p /app/logs /app/data /app/reports /app/sessions /app/monitoring \
    /app/logs/agentcore /app/logs/agents /app/logs/system \
    /app/data/state /app/data/messages /app/data/sessions \
    /app/reports/health /app/reports/metrics /app/reports/performance \
    /app/monitoring/prometheus /app/monitoring/grafana

# Set environment variables for development
ENV PYTHONPATH=/app
ENV PYTHONUNBUFFERED=1
ENV DEVELOPMENT_MODE=true
ENV LOG_LEVEL=DEBUG
ENV AGENTCORE_SIMULATION=true

# Create enhanced health check script
RUN echo '#!/bin/bash\n\
# Check main service\n\
curl -f http://localhost:8000/health || exit 1\n\
\n\
# Check message bus connectivity\n\
curl -f http://localhost:8000/messages/history?limit=1 || exit 1\n\
\n\
# Check agent registry\n\
curl -f http://localhost:8000/agents || exit 1\n\
' > /app/healthcheck.sh && chmod +x /app/healthcheck.sh

# Expose ports for AgentCore services
EXPOSE 8000 9090 9091

# Enhanced health check with multiple validation points
HEALTHCHECK --interval=30s --timeout=15s --start-period=60s --retries=5 \
    CMD /app/healthcheck.sh

# Start the enhanced mock AgentCore Runtime with development features
CMD ["python", "-m", "uvicorn", "mock-agentcore.main_enhanced:app", "--host", "0.0.0.0", "--port", "8000", "--reload", "--log-level", "debug"]