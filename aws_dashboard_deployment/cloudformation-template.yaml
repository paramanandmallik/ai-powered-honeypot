AWSTemplateFormatVersion: '2010-09-09'
Description: AI-Powered Honeypot Dashboard - CloudFormation Deployment

Parameters:
  DashboardName:
    Type: String
    Default: honeypot-dashboard
    Description: Name for the dashboard resources

Resources:
  # Lambda Execution Role
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: DashboardPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: '*'

  # Lambda Function
  DashboardFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${DashboardName}-function'
      Runtime: python3.9
      Handler: index.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 30
      MemorySize: 512
      Code:
        ZipFile: |
          import json
          import time
          from datetime import datetime, timedelta
          import random
          import base64

          def get_architecture_diagram_base64():
              # This would normally contain the base64 encoded architecture diagram
              # For now, return empty string - diagram would be embedded here
              return ""

          def lambda_handler(event, context):
              http_method = event.get('httpMethod', 'GET')
              path = event.get('path', '/')
              
              if path == '/' and http_method == 'GET':
                  return serve_dashboard()
              elif path == '/api/status' and http_method == 'GET':
                  return serve_status_api()
              elif path == '/api/threats' and http_method == 'GET':
                  return serve_threats_api()
              elif path == '/api/engagements' and http_method == 'GET':
                  return serve_engagements_api()
              elif path == '/api/intelligence' and http_method == 'GET':
                  return serve_intelligence_api()
              elif path == '/api/detailed-intelligence' and http_method == 'GET':
                  return serve_detailed_intelligence_api()
              else:
                  return {
                      'statusCode': 404,
                      'headers': {'Content-Type': 'application/json'},
                      'body': json.dumps({'error': 'Not found'})
                  }

          def serve_dashboard():
              html = '''<!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>AI-Powered Honeypot System Dashboard</title>
              <style>
                  * { margin: 0; padding: 0; box-sizing: border-box; }
                  
                  body {
                      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
                      color: #fff;
                      min-height: 100vh;
                  }
                  
                  .header {
                      background: rgba(0,0,0,0.2);
                      padding: 1rem 2rem;
                      text-align: center;
                      border-bottom: 1px solid rgba(255,255,255,0.1);
                  }
                  
                  .header h1 {
                      font-size: 2rem;
                      font-weight: 300;
                  }
                  
                  .subtitle {
                      color: rgba(255,255,255,0.8);
                      margin-top: 0.5rem;
                  }
                  
                  .aws-badge {
                      background: #FF9900;
                      color: #232F3E;
                      padding: 0.5rem 1rem;
                      border-radius: 25px;
                      font-size: 1rem;
                      font-weight: bold;
                      margin-top: 1rem;
                      display: inline-block;
                  }
                  
                  .container {
                      padding: 2rem;
                      max-width: 1400px;
                      margin: 0 auto;
                  }
                  
                  .grid {
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                      gap: 1.5rem;
                      margin-bottom: 2rem;
                  }
                  
                  .card {
                      background: rgba(255,255,255,0.1);
                      border-radius: 12px;
                      padding: 1.5rem;
                      backdrop-filter: blur(10px);
                      border: 1px solid rgba(255,255,255,0.2);
                      transition: transform 0.3s ease;
                  }
                  
                  .card:hover {
                      transform: translateY(-5px);
                  }
                  
                  .card h3 {
                      margin-bottom: 1rem;
                      color: #fff;
                      font-size: 1.2rem;
                  }
                  
                  .status-indicator {
                      display: inline-block;
                      width: 12px;
                      height: 12px;
                      border-radius: 50%;
                      margin-right: 8px;
                  }
                  
                  .status-healthy { background: #4CAF50; }
                  .status-warning { background: #FF9800; }
                  .status-critical { background: #F44336; }
                  
                  .metric {
                      display: flex;
                      justify-content: space-between;
                      align-items: center;
                      padding: 0.5rem 0;
                      border-bottom: 1px solid rgba(255,255,255,0.1);
                  }
                  
                  .metric:last-child {
                      border-bottom: none;
                  }
                  
                  .metric-value {
                      font-weight: bold;
                      font-size: 1.1rem;
                  }
                  
                  .honeypot-item {
                      background: rgba(0,0,0,0.2);
                      padding: 1rem;
                      margin: 0.5rem 0;
                      border-radius: 8px;
                      border-left: 4px solid #4CAF50;
                  }
                  
                  .honeypot-header {
                      display: flex;
                      align-items: center;
                      justify-content: space-between;
                      margin-bottom: 0.5rem;
                  }
                  
                  .honeypot-status {
                      background: rgba(76, 175, 80, 0.2);
                      color: #4CAF50;
                      padding: 0.2rem 0.6rem;
                      border-radius: 12px;
                      font-size: 0.8rem;
                      font-weight: bold;
                  }
                  
                  .honeypot-details {
                      font-size: 0.9rem;
                      color: rgba(255,255,255,0.8);
                      line-height: 1.4;
                  }
                  
                  .honeypot-details div {
                      margin: 0.2rem 0;
                  }
                  
                  .threat-item, .engagement-item {
                      background: rgba(0,0,0,0.2);
                      padding: 1rem;
                      margin: 0.5rem 0;
                      border-radius: 8px;
                      border-left: 4px solid #FF5722;
                  }
                  
                  .engagement-item {
                      border-left-color: #2196F3;
                  }
                  
                  .intelligence-item {
                      background: rgba(0,0,0,0.2);
                      padding: 1rem;
                      margin: 0.5rem 0;
                      border-radius: 8px;
                      border-left: 4px solid #4CAF50;
                  }
                  
                  .timestamp {
                      color: rgba(255,255,255,0.7);
                      font-size: 0.9rem;
                  }
                  
                  .confidence-bar {
                      background: rgba(255,255,255,0.2);
                      height: 6px;
                      border-radius: 3px;
                      overflow: hidden;
                      margin: 0.5rem 0;
                  }
                  
                  .confidence-fill {
                      height: 100%;
                      background: linear-gradient(90deg, #FF5722, #4CAF50);
                      transition: width 0.3s ease;
                  }
                  
                  .refresh-btn {
                      position: fixed;
                      bottom: 2rem;
                      right: 2rem;
                      background: #4CAF50;
                      color: white;
                      border: none;
                      padding: 1rem;
                      border-radius: 50%;
                      cursor: pointer;
                      font-size: 1.2rem;
                      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                      transition: all 0.3s ease;
                  }
                  
                  .refresh-btn:hover {
                      background: #45a049;
                      transform: scale(1.1);
                  }
                  
                  .auto-refresh {
                      color: rgba(255,255,255,0.7);
                      font-size: 0.9rem;
                      margin-top: 1rem;
                  }
                  
                  .architecture-diagram {
                      text-align: center;
                      margin: 2rem 0;
                      padding: 2rem;
                      background: rgba(255,255,255,0.05);
                      border-radius: 12px;
                      border: 1px solid rgba(255,255,255,0.1);
                  }
                  
                  .architecture-diagram img {
                      max-width: 100%;
                      height: auto;
                      border-radius: 8px;
                      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                  }
                  
                  @keyframes pulse {
                      0% { opacity: 1; }
                      50% { opacity: 0.5; }
                      100% { opacity: 1; }
                  }
                  
                  .loading {
                      animation: pulse 1.5s infinite;
                  }
              </style>
          </head>
          <body>
              <div class="header">
                  <h1>üé≠ Honeypot System</h1>
                  <div class="subtitle">Real-time Threat Detection & Intelligence Dashboard</div>
                  <div class="aws-badge">ü§ñ Powered by Amazon Bedrock Agentcore</div>
              </div>
              
              <div class="container">
                  <div class="grid">
                      <!-- System Status -->
                      <div class="card">
                          <h3>üöÄ System Status</h3>
                          <div id="system-status">
                              <div class="metric">
                                  <span><span class="status-indicator status-healthy"></span>Detection Agent</span>
                                  <span class="metric-value">Online</span>
                              </div>
                              <div class="metric">
                                  <span><span class="status-indicator status-healthy"></span>Coordinator Agent</span>
                                  <span class="metric-value">Online</span>
                              </div>
                              <div class="metric">
                                  <span><span class="status-indicator status-healthy"></span>Interaction Agent</span>
                                  <span class="metric-value">Online</span>
                              </div>
                              <div class="metric">
                                  <span><span class="status-indicator status-healthy"></span>Intelligence Agent</span>
                                  <span class="metric-value">Online</span>
                              </div>
                          </div>
                      </div>
                      
                      <!-- Live Metrics -->
                      <div class="card">
                          <h3>üìä Live Metrics</h3>
                          <div id="live-metrics">
                              <div class="metric">
                                  <span>Threats Detected (24h)</span>
                                  <span class="metric-value" id="threats-count">0</span>
                              </div>
                              <div class="metric">
                                  <span>Active Engagements</span>
                                  <span class="metric-value" id="engagements-count">0</span>
                              </div>
                              <div class="metric">
                                  <span>Intelligence Reports</span>
                                  <span class="metric-value" id="reports-count">0</span>
                              </div>
                              <div class="metric">
                                  <span>System Uptime</span>
                                  <span class="metric-value">99.9%</span>
                              </div>
                          </div>
                      </div>
                      
                      <!-- Honeypot Infrastructure - Part 1 -->
                      <div class="card">
                          <h3>üé™ Honeypot Infrastructure</h3>
                          <div class="honeypot-item">
                              <div class="honeypot-header">
                                  <span><span class="status-indicator status-healthy"></span><strong>Web Admin Portal</strong></span>
                                  <span class="honeypot-status">Active</span>
                              </div>
                              <div class="honeypot-details">
                                  <div><strong>IP:</strong> 10.0.1.100:8080</div>
                                  <div><strong>Instance:</strong> i-0a1b2c3d4e5f6g7h8</div>
                                  <div><strong>Engagements:</strong> 2 active</div>
                              </div>
                          </div>
                          
                          <div class="honeypot-item">
                              <div class="honeypot-header">
                                  <span><span class="status-indicator status-healthy"></span><strong>SSH Honeypot</strong></span>
                                  <span class="honeypot-status">Active</span>
                              </div>
                              <div class="honeypot-details">
                                  <div><strong>IP:</strong> 10.0.1.101:22</div>
                                  <div><strong>Instance:</strong> i-0b2c3d4e5f6g7h8i9</div>
                                  <div><strong>Engagements:</strong> 1 active</div>
                              </div>
                          </div>
                      </div>
                      
                      <!-- Honeypot Infrastructure - Part 2 -->
                      <div class="card">
                          <h3>üé™ Additional Honeypots</h3>
                          <div class="honeypot-item">
                              <div class="honeypot-header">
                                  <span><span class="status-indicator status-healthy"></span><strong>Database Honeypot</strong></span>
                                  <span class="honeypot-status">Active</span>
                              </div>
                              <div class="honeypot-details">
                                  <div><strong>IP:</strong> 10.0.1.102:3306</div>
                                  <div><strong>RDS:</strong> honeypot-mysql-001</div>
                                  <div><strong>Engagements:</strong> 0 active</div>
                              </div>
                          </div>
                          
                          <div class="honeypot-item">
                              <div class="honeypot-header">
                                  <span><span class="status-indicator status-warning"></span><strong>File Share</strong></span>
                                  <span class="honeypot-status">Standby</span>
                              </div>
                              <div class="honeypot-details">
                                  <div><strong>IP:</strong> 10.0.1.103:445</div>
                                  <div><strong>Instance:</strong> i-0c3d4e5f6g7h8i9j0</div>
                                  <div><strong>Engagements:</strong> 0 active</div>
                              </div>
                          </div>
                      </div>
                  </div>
                  
                  <div class="grid">
                      <!-- Recent Threats -->
                      <div class="card">
                          <h3>üö® Recent Threats</h3>
                          <div id="recent-threats">
                              <div class="loading">Loading threat data...</div>
                          </div>
                      </div>
                      
                      <!-- Active Engagements -->
                      <div class="card">
                          <h3>üé≠ Active Engagements</h3>
                          <div id="active-engagements">
                              <div class="loading">Loading engagement data...</div>
                          </div>
                      </div>
                      
                      <!-- Intelligence Reports -->
                      <div class="card">
                          <h3>üß† Latest Intelligence</h3>
                          <div id="intelligence-reports">
                              <div class="loading">Loading intelligence data...</div>
                          </div>
                      </div>
                  </div>
                  
                  <!-- Architecture Diagram -->
                  <div class="architecture-diagram">
                      <h3>üèóÔ∏è System Architecture</h3>
                      <div style="text-align: center; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
                          <img src="https://d3nswgo2anpzyz.cloudfront.net/architecture-diagram.png" 
                               alt="System Architecture" 
                               style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);" />
                          <div style="margin-top: 1rem; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 8px;">
                              <p style="font-size: 0.9rem; color: rgba(255,255,255,0.8);">Advanced AI agents working together to detect, engage, and analyze cyber threats</p>
                          </div>
                      </div>
                  </div>
                  
                  <div class="auto-refresh">
                      üîÑ Auto-refreshing every 5 seconds | Last updated: <span id="last-update">Never</span>
                  </div>
              </div>
              
              <button class="refresh-btn" onclick="refreshData()" title="Refresh Data">üîÑ</button>
              
              <script>
                  let refreshInterval;
                  
                  function updateTimestamp() {
                      const now = new Date();
                      document.getElementById('last-update').textContent = now.toLocaleTimeString();
                  }
                  
                  async function fetchData(endpoint) {
                      try {
                          const response = await fetch(endpoint);
                          return await response.json();
                      } catch (error) {
                          console.error('Error fetching data:', error);
                          return null;
                      }
                  }
                  
                  async function refreshData() {
                      // Update threats
                      const threats = await fetchData('/prod/api/threats');
                      if (threats) {
                          document.getElementById('threats-count').textContent = threats.length;
                          
                          const threatsHtml = threats.map(threat => `
                              <div class="threat-item">
                                  <div><strong>${threat.type}</strong></div>
                                  <div>Source: ${threat.source_ip}</div>
                                  <div>Confidence: ${(threat.confidence * 100).toFixed(1)}%</div>
                                  <div class="confidence-bar">
                                      <div class="confidence-fill" style="width: ${threat.confidence * 100}%"></div>
                                  </div>
                                  <div class="timestamp">${threat.timestamp}</div>
                              </div>
                          `).join('');
                          
                          document.getElementById('recent-threats').innerHTML = threatsHtml || '<div>No recent threats</div>';
                      }
                      
                      // Update engagements
                      const engagements = await fetchData('/prod/api/engagements');
                      if (engagements) {
                          document.getElementById('engagements-count').textContent = engagements.length;
                          
                          const engagementsHtml = engagements.map(engagement => `
                              <div class="engagement-item">
                                  <div><strong>${engagement.honeypot_type}</strong> - ${engagement.status}</div>
                                  <div>Attacker: ${engagement.attacker_ip}</div>
                                  <div>Duration: ${engagement.duration}s</div>
                                  <div class="timestamp">${engagement.start_time}</div>
                              </div>
                          `).join('');
                          
                          document.getElementById('active-engagements').innerHTML = engagementsHtml || '<div>No active engagements</div>';
                      }
                      
                      // Update intelligence
                      const intelligence = await fetchData('/prod/api/intelligence');
                      if (intelligence) {
                          document.getElementById('reports-count').textContent = intelligence.length;
                          
                          const intelligenceHtml = intelligence.map(report => `
                              <div class="intelligence-item">
                                  <div><strong>${report.attack_type}</strong></div>
                                  <div>MITRE: ${report.mitre_techniques.join(', ')}</div>
                                  <div>IOCs: ${report.iocs_count}</div>
                                  <div class="timestamp">${report.generated_at}</div>
                              </div>
                          `).join('');
                          
                          document.getElementById('intelligence-reports').innerHTML = intelligenceHtml || '<div>No intelligence reports</div>';
                      }
                      
                      updateTimestamp();
                  }
                  
                  function startAutoRefresh() {
                      updateTimestamp(); // Set initial timestamp
                      refreshData(); // Initial load
                      refreshInterval = setInterval(function() {
                          refreshData();
                          updateTimestamp();
                      }, 5000); // Refresh every 5 seconds
                  }
                  
                  // Start auto-refresh when page loads
                  window.addEventListener('load', function() {
                      startAutoRefresh();
                      // Also update timestamp immediately
                      updateTimestamp();
                  });
                  
                  // Handle page visibility changes
                  document.addEventListener('visibilitychange', function() {
                      if (document.hidden) {
                          clearInterval(refreshInterval);
                      } else {
                          startAutoRefresh();
                      }
                  });
              </script>
          </body>
          </html>'''
              
              return {
                  'statusCode': 200,
                  'headers': {'Content-Type': 'text/html'},
                  'body': html
              }

          def serve_status_api():
              return {
                  'statusCode': 200,
                  'headers': {'Content-Type': 'application/json'},
                  'body': json.dumps({"status": "healthy", "timestamp": datetime.now().isoformat()})
              }

          def serve_threats_api():
              threats = []
              
              threat_types = ["SQL Injection", "XSS Attack", "Brute Force", "Directory Traversal", "Command Injection"]
              source_ips = ["192.168.1.100", "10.0.0.50", "172.16.0.25", "203.0.113.10"]
              
              # Generate some recent threats
              for i in range(random.randint(3, 8)):
                  threat_time = datetime.now() - timedelta(minutes=random.randint(1, 120))
                  threats.append({
                      "id": f"threat_{i+1}",
                      "type": random.choice(threat_types),
                      "source_ip": random.choice(source_ips),
                      "confidence": random.uniform(0.7, 0.95),
                      "timestamp": threat_time.strftime("%H:%M:%S"),
                      "status": "detected"
                  })
              
              # Sort by most recent first
              threats.sort(key=lambda x: x["timestamp"], reverse=True)
              
              return {
                  'statusCode': 200,
                  'headers': {'Content-Type': 'application/json'},
                  'body': json.dumps(threats[:5])
              }

          def serve_engagements_api():
              engagements = []
              
              honeypot_types = ["web_admin", "ssh", "database"]
              attacker_ips = ["192.168.1.100", "10.0.0.50", "172.16.0.25"]
              
              # Generate some active engagements
              for i in range(random.randint(1, 4)):
                  start_time = datetime.now() - timedelta(minutes=random.randint(1, 30))
                  engagements.append({
                      "id": f"engagement_{i+1}",
                      "honeypot_type": random.choice(honeypot_types),
                      "attacker_ip": random.choice(attacker_ips),
                      "status": "active",
                      "start_time": start_time.strftime("%H:%M:%S"),
                      "duration": random.randint(30, 300),
                      "interactions": random.randint(5, 25)
                  })
              
              return {
                  'statusCode': 200,
                  'headers': {'Content-Type': 'application/json'},
                  'body': json.dumps(engagements)
              }

          def serve_intelligence_api():
              reports = []
              
              attack_types = [
                  "Multi-Vector Web Attack Campaign",
                  "SSH Brute Force Campaign", 
                  "Database Exploitation Attempt",
                  "Reconnaissance and Enumeration"
              ]
              
              mitre_techniques = [
                  ["T1190", "T1059"],
                  ["T1110", "T1021"],
                  ["T1190", "T1083"],
                  ["T1046", "T1018"]
              ]
              
              # Generate some intelligence reports
              for i in range(random.randint(2, 5)):
                  generated_time = datetime.now() - timedelta(hours=random.randint(1, 24))
                  attack_type = random.choice(attack_types)
                  techniques = random.choice(mitre_techniques)
                  
                  reports.append({
                      "id": f"report_{i+1}",
                      "attack_type": attack_type,
                      "mitre_techniques": techniques,
                      "iocs_count": random.randint(3, 12),
                      "confidence": random.uniform(0.8, 0.95),
                      "generated_at": generated_time.strftime("%H:%M:%S"),
                      "threat_level": "high" if random.random() > 0.5 else "medium"
                  })
              
              # Sort by most recent first
              reports.sort(key=lambda x: x["generated_at"], reverse=True)
              
              return {
                  'statusCode': 200,
                  'headers': {'Content-Type': 'application/json'},
                  'body': json.dumps(reports[:3])
              }

          def serve_detailed_intelligence_api():
              return {
                  'statusCode': 200,
                  'headers': {'Content-Type': 'application/json'},
                  'body': json.dumps([{"campaign_name": "Demo Campaign", "confidence": 0.89}])
              }

  # API Gateway
  ApiGateway:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: !Sub '${DashboardName}-api'
      Description: AI-Powered Honeypot Dashboard API
      EndpointConfiguration:
        Types:
          - EDGE

  # API Gateway Resource (Proxy)
  ProxyResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref ApiGateway
      ParentId: !GetAtt ApiGateway.RootResourceId
      PathPart: '{proxy+}'

  # API Gateway Method (ANY)
  ProxyMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref ApiGateway
      ResourceId: !Ref ProxyResource
      HttpMethod: ANY
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${DashboardFunction.Arn}/invocations'

  # Root Method
  RootMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref ApiGateway
      ResourceId: !GetAtt ApiGateway.RootResourceId
      HttpMethod: ANY
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${DashboardFunction.Arn}/invocations'

  # API Gateway Deployment
  ApiDeployment:
    Type: AWS::ApiGateway::Deployment
    DependsOn:
      - ProxyMethod
      - RootMethod
    Properties:
      RestApiId: !Ref ApiGateway
      StageName: prod

  # Lambda Permission for API Gateway
  LambdaApiGatewayPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref DashboardFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ApiGateway}/*/*/*'



Outputs:
  DashboardUrl:
    Description: "Public URL for the AI-Powered Honeypot Dashboard"
    Value: !Sub 'https://${ApiGateway}.execute-api.${AWS::Region}.amazonaws.com/prod/'
    Export:
      Name: !Sub '${DashboardName}-url'
      
  LambdaFunctionArn:
    Description: "Lambda Function ARN"
    Value: !GetAtt DashboardFunction.Arn
    Export:
      Name: !Sub '${DashboardName}-function-arn'