AWSTemplateFormatVersion: '2010-09-09'
Description: AI-Powered Honeypot Dashboard - CloudFormation Deployment

Parameters:
  DashboardName:
    Type: String
    Default: honeypot-dashboard
    Description: Name for the dashboard resources

Resources:
  # Lambda Execution Role
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: DashboardPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: '*'

  # Lambda Function
  DashboardFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${DashboardName}-function'
      Runtime: python3.9
      Handler: index.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 30
      MemorySize: 256
      Code:
        ZipFile: |
          import json
          import time
          from datetime import datetime, timedelta
          import random

          def lambda_handler(event, context):
              http_method = event.get('httpMethod', 'GET')
              path = event.get('path', '/')
              
              if path == '/' and http_method == 'GET':
                  return serve_dashboard()
              elif path == '/api/status' and http_method == 'GET':
                  return serve_status_api()
              elif path == '/api/threats' and http_method == 'GET':
                  return serve_threats_api()
              elif path == '/api/engagements' and http_method == 'GET':
                  return serve_engagements_api()
              elif path == '/api/intelligence' and http_method == 'GET':
                  return serve_intelligence_api()
              elif path == '/api/detailed-intelligence' and http_method == 'GET':
                  return serve_detailed_intelligence_api()
              else:
                  return {
                      'statusCode': 404,
                      'headers': {'Content-Type': 'application/json'},
                      'body': json.dumps({'error': 'Not found'})
                  }

          def serve_dashboard():
              html = '''<!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>AI-Powered Honeypot System Dashboard</title>
              <style>
                  * { margin: 0; padding: 0; box-sizing: border-box; }
                  body {
                      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
                      color: #fff;
                      min-height: 100vh;
                  }
                  .header {
                      background: rgba(0,0,0,0.2);
                      padding: 1.5rem;
                      text-align: center;
                      border-bottom: 1px solid rgba(255,255,255,0.1);
                  }
                  .header h1 {
                      font-size: 2.2rem;
                      font-weight: 300;
                      margin-bottom: 0.3rem;
                  }
                  .subtitle {
                      color: rgba(255,255,255,0.8);
                      font-size: 1rem;
                  }
                  .aws-badge {
                      background: #FF9900;
                      color: #232F3E;
                      padding: 0.5rem 1rem;
                      border-radius: 25px;
                      font-size: 1rem;
                      font-weight: bold;
                      margin-top: 1rem;
                      display: inline-block;
                  }
                  .container {
                      padding: 1rem;
                      max-width: 1400px;
                      margin: 0 auto;
                  }
                  .grid {
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                      gap: 1rem;
                      margin-bottom: 1.5rem;
                  }
                  .card {
                      background: rgba(255,255,255,0.1);
                      border-radius: 10px;
                      padding: 1.2rem;
                      backdrop-filter: blur(10px);
                      border: 1px solid rgba(255,255,255,0.2);
                      transition: transform 0.3s ease;
                  }
                  .card:hover {
                      transform: translateY(-5px);
                  }
                  .card h3 {
                      margin-bottom: 1rem;
                      color: #fff;
                      font-size: 1.1rem;
                  }
                  .status-indicator {
                      display: inline-block;
                      width: 12px;
                      height: 12px;
                      border-radius: 50%;
                      margin-right: 8px;
                  }
                  .status-healthy { background: #4CAF50; }
                  .status-warning { background: #FF9800; }
                  .metric {
                      display: flex;
                      justify-content: space-between;
                      align-items: center;
                      padding: 0.5rem 0;
                      border-bottom: 1px solid rgba(255,255,255,0.1);
                      font-size: 0.9rem;
                  }
                  .metric:last-child { border-bottom: none; }
                  .metric-value {
                      font-weight: bold;
                      font-size: 1rem;
                  }
                  .honeypot-item {
                      background: rgba(0,0,0,0.2);
                      padding: 1rem;
                      margin: 0.5rem 0;
                      border-radius: 8px;
                      border-left: 3px solid #4CAF50;
                  }
                  .honeypot-header {
                      display: flex;
                      align-items: center;
                      justify-content: space-between;
                      margin-bottom: 0.5rem;
                  }
                  .honeypot-status {
                      background: rgba(76, 175, 80, 0.2);
                      color: #4CAF50;
                      padding: 0.3rem 0.8rem;
                      border-radius: 15px;
                      font-size: 0.9rem;
                      font-weight: bold;
                  }
                  .honeypot-details {
                      font-size: 0.85rem;
                      color: rgba(255,255,255,0.8);
                      line-height: 1.4;
                  }
                  .honeypot-details div {
                      margin: 0.2rem 0;
                  }
                  .full-width {
                      grid-column: 1 / -1;
                  }
                  .intelligence-detail {
                      background: rgba(0,0,0,0.2);
                      padding: 2rem;
                      margin: 1rem 0;
                      border-radius: 10px;
                      border-left: 4px solid #9C27B0;
                  }
                  .intelligence-header {
                      display: flex;
                      justify-content: space-between;
                      align-items: center;
                      margin-bottom: 1.5rem;
                  }
                  .intelligence-title {
                      font-size: 1.3rem;
                      font-weight: bold;
                  }
                  .confidence-badge {
                      background: rgba(76, 175, 80, 0.2);
                      color: #4CAF50;
                      padding: 0.5rem 1rem;
                      border-radius: 20px;
                      font-size: 1rem;
                      font-weight: bold;
                  }
                  .intelligence-content {
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                      gap: 1.5rem;
                      margin-top: 1.5rem;
                  }
                  .intelligence-section {
                      background: rgba(255,255,255,0.05);
                      padding: 1.5rem;
                      border-radius: 8px;
                  }
                  .intelligence-section h4 {
                      color: #fff;
                      margin-bottom: 1rem;
                      font-size: 1.1rem;
                  }
                  .ioc-list, .mitre-list {
                      list-style: none;
                      padding: 0;
                  }
                  .ioc-list li, .mitre-list li {
                      background: rgba(0,0,0,0.3);
                      padding: 0.5rem 0.8rem;
                      margin: 0.3rem 0;
                      border-radius: 6px;
                      font-family: monospace;
                      font-size: 0.9rem;
                  }
                  .mitre-list li {
                      background: rgba(33, 150, 243, 0.2);
                      color: #2196F3;
                  }
                  .timeline-item {
                      display: flex;
                      align-items: center;
                      margin: 0.8rem 0;
                      font-size: 0.95rem;
                  }
                  .timeline-time {
                      background: rgba(255,255,255,0.1);
                      padding: 0.3rem 0.8rem;
                      border-radius: 6px;
                      margin-right: 1rem;
                      min-width: 90px;
                      text-align: center;
                      font-weight: bold;
                  }
                  .refresh-btn {
                      position: fixed;
                      bottom: 2rem;
                      right: 2rem;
                      background: #4CAF50;
                      color: white;
                      border: none;
                      padding: 1rem;
                      border-radius: 50%;
                      cursor: pointer;
                      font-size: 1.2rem;
                      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                  }
                  .auto-refresh {
                      color: rgba(255,255,255,0.7);
                      font-size: 1rem;
                      margin-top: 2rem;
                      text-align: center;
                  }
              </style>
          </head>
          <body>
              <div class="header">
                  <h1>üé≠ AI-Powered Honeypot System</h1>
                  <div class="subtitle">Real-time Threat Detection & Intelligence Dashboard</div>
                  <div class="aws-badge">ü§ñ Powered by Amazon Bedrock Agentcore</div>
              </div>
              
              <div class="container">
                  <div class="grid">
                      <div class="card">
                          <h3>üöÄ System Status</h3>
                          <div class="metric">
                              <span><span class="status-indicator status-healthy"></span>Detection Agent</span>
                              <span class="metric-value">Online</span>
                          </div>
                          <div class="metric">
                              <span><span class="status-indicator status-healthy"></span>Coordinator Agent</span>
                              <span class="metric-value">Online</span>
                          </div>
                          <div class="metric">
                              <span><span class="status-indicator status-healthy"></span>Interaction Agent</span>
                              <span class="metric-value">Online</span>
                          </div>
                          <div class="metric">
                              <span><span class="status-indicator status-healthy"></span>Intelligence Agent</span>
                              <span class="metric-value">Online</span>
                          </div>
                      </div>
                      
                      <div class="card">
                          <h3>üìä Live Metrics</h3>
                          <div class="metric">
                              <span>Threats Detected (24h)</span>
                              <span class="metric-value" id="threats-count">12</span>
                          </div>
                          <div class="metric">
                              <span>Active Engagements</span>
                              <span class="metric-value" id="engagements-count">3</span>
                          </div>
                          <div class="metric">
                              <span>Intelligence Reports</span>
                              <span class="metric-value" id="reports-count">5</span>
                          </div>
                          <div class="metric">
                              <span>System Uptime</span>
                              <span class="metric-value">99.9%</span>
                          </div>
                      </div>
                      
                      <div class="card">
                          <h3>üé™ Honeypot Infrastructure</h3>
                          <div class="honeypot-item">
                              <div class="honeypot-header">
                                  <span class="status-indicator status-healthy"></span>
                                  <strong>Web Admin Portal</strong>
                                  <span class="honeypot-status">Active</span>
                              </div>
                              <div class="honeypot-details">
                                  <div><strong>IP:</strong> 10.0.1.100:8080</div>
                                  <div><strong>Instance:</strong> i-0a1b2c3d4e5f6g7h8</div>
                                  <div><strong>Engagements:</strong> 2 active</div>
                              </div>
                          </div>
                          
                          <div class="honeypot-item">
                              <div class="honeypot-header">
                                  <span class="status-indicator status-healthy"></span>
                                  <strong>SSH Honeypot</strong>
                                  <span class="honeypot-status">Active</span>
                              </div>
                              <div class="honeypot-details">
                                  <div><strong>IP:</strong> 10.0.1.101:22</div>
                                  <div><strong>Instance:</strong> i-0b2c3d4e5f6g7h8i9</div>
                                  <div><strong>Engagements:</strong> 1 active</div>
                              </div>
                          </div>
                          
                          <div class="honeypot-item">
                              <div class="honeypot-header">
                                  <span class="status-indicator status-healthy"></span>
                                  <strong>Database Honeypot</strong>
                                  <span class="honeypot-status">Active</span>
                              </div>
                              <div class="honeypot-details">
                                  <div><strong>IP:</strong> 10.0.1.102:3306</div>
                                  <div><strong>RDS:</strong> honeypot-mysql-001</div>
                                  <div><strong>Engagements:</strong> 0 active</div>
                              </div>
                          </div>
                      </div>
                  </div>
                  
                  <div class="card full-width">
                      <h3>üß† Detailed Intelligence Analysis</h3>
                      <div class="intelligence-detail">
                          <div class="intelligence-header">
                              <div class="intelligence-title">Multi-Vector Web Application Attack Campaign</div>
                              <div class="confidence-badge">89.0% Confidence</div>
                          </div>
                          
                          <div class="intelligence-content">
                              <div class="intelligence-section">
                                  <h4>üéØ MITRE ATT&CK Techniques</h4>
                                  <ul class="mitre-list">
                                      <li>T1190: Exploit Public-Facing Application</li>
                                      <li>T1059.007: JavaScript</li>
                                      <li>T1110.001: Password Guessing</li>
                                      <li>T1083: File and Directory Discovery</li>
                                  </ul>
                              </div>
                              
                              <div class="intelligence-section">
                                  <h4>üö© Indicators of Compromise</h4>
                                  <ul class="ioc-list">
                                      <li>IP: 192.168.1.100</li>
                                      <li>SQL: ' OR '1'='1 --</li>
                                      <li>XSS: &lt;script&gt;alert('XSS')&lt;/script&gt;</li>
                                      <li>Cred: admin:password123</li>
                                      <li>Path: ../../../etc/passwd</li>
                                  </ul>
                              </div>
                              
                              <div class="intelligence-section">
                                  <h4>üë§ Threat Actor Profile</h4>
                                  <div><strong>Sophistication:</strong> Low-Medium</div>
                                  <div><strong>Motivation:</strong> Opportunistic/Financial</div>
                                  <div><strong>Tools:</strong> Automated scanners</div>
                                  <div><strong>Attribution:</strong> Script kiddie</div>
                              </div>
                              
                              <div class="intelligence-section">
                                  <h4>‚è±Ô∏è Attack Timeline</h4>
                                  <div class="timeline-item">
                                      <div class="timeline-time">14:30:15</div>
                                      <div>Initial reconnaissance - port scanning</div>
                                  </div>
                                  <div class="timeline-item">
                                      <div class="timeline-time">14:31:22</div>
                                      <div>SQL injection attempts on login form</div>
                                  </div>
                                  <div class="timeline-item">
                                      <div class="timeline-time">14:32:45</div>
                                      <div>XSS payload injection in search</div>
                                  </div>
                                  <div class="timeline-item">
                                      <div class="timeline-time">14:34:12</div>
                                      <div>Brute force attack on admin credentials</div>
                                  </div>
                              </div>
                          </div>
                          
                          <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                              <strong>üìä Summary:</strong> Coordinated multi-vector attack targeting web application vulnerabilities. 
                              Attacker demonstrated knowledge of common techniques but used basic payloads suggesting automated tooling.
                          </div>
                      </div>
                  </div>
                  
                  <div class="auto-refresh">
                      üîÑ Live AWS Dashboard | Last updated: ''' + datetime.now().strftime("%H:%M:%S") + '''
                  </div>
              </div>
              
              <button class="refresh-btn" onclick="location.reload()" title="Refresh Data">üîÑ</button>
          </body>
          </html>'''
              
              return {
                  'statusCode': 200,
                  'headers': {'Content-Type': 'text/html'},
                  'body': html
              }

          def serve_status_api():
              return {
                  'statusCode': 200,
                  'headers': {'Content-Type': 'application/json'},
                  'body': json.dumps({"status": "healthy", "timestamp": datetime.now().isoformat()})
              }

          def serve_threats_api():
              threats = [
                  {"type": "SQL Injection", "confidence": 0.89, "source_ip": "192.168.1.100"},
                  {"type": "XSS Attack", "confidence": 0.82, "source_ip": "10.0.0.50"}
              ]
              return {
                  'statusCode': 200,
                  'headers': {'Content-Type': 'application/json'},
                  'body': json.dumps(threats)
              }

          def serve_engagements_api():
              engagements = [
                  {"honeypot_type": "web_admin", "attacker_ip": "192.168.1.100", "status": "active", "duration": 145}
              ]
              return {
                  'statusCode': 200,
                  'headers': {'Content-Type': 'application/json'},
                  'body': json.dumps(engagements)
              }

          def serve_intelligence_api():
              reports = [
                  {"attack_type": "Web Attack Campaign", "mitre_techniques": ["T1190", "T1059"], "iocs_count": 5}
              ]
              return {
                  'statusCode': 200,
                  'headers': {'Content-Type': 'application/json'},
                  'body': json.dumps(reports)
              }

          def serve_detailed_intelligence_api():
              return {
                  'statusCode': 200,
                  'headers': {'Content-Type': 'application/json'},
                  'body': json.dumps([{"campaign_name": "Demo Campaign", "confidence": 0.89}])
              }

  # API Gateway
  ApiGateway:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: !Sub '${DashboardName}-api'
      Description: AI-Powered Honeypot Dashboard API
      EndpointConfiguration:
        Types:
          - EDGE

  # API Gateway Resource (Proxy)
  ProxyResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref ApiGateway
      ParentId: !GetAtt ApiGateway.RootResourceId
      PathPart: '{proxy+}'

  # API Gateway Method (ANY)
  ProxyMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref ApiGateway
      ResourceId: !Ref ProxyResource
      HttpMethod: ANY
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${DashboardFunction.Arn}/invocations'

  # Root Method
  RootMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref ApiGateway
      ResourceId: !GetAtt ApiGateway.RootResourceId
      HttpMethod: ANY
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${DashboardFunction.Arn}/invocations'

  # API Gateway Deployment
  ApiDeployment:
    Type: AWS::ApiGateway::Deployment
    DependsOn:
      - ProxyMethod
      - RootMethod
    Properties:
      RestApiId: !Ref ApiGateway
      StageName: prod

  # Lambda Permission for API Gateway
  LambdaApiGatewayPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref DashboardFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ApiGateway}/*/*/*'

Outputs:
  DashboardUrl:
    Description: "Public URL for the AI-Powered Honeypot Dashboard"
    Value: !Sub 'https://${ApiGateway}.execute-api.${AWS::Region}.amazonaws.com/prod/'
    Export:
      Name: !Sub '${DashboardName}-url'
      
  LambdaFunctionArn:
    Description: "Lambda Function ARN"
    Value: !GetAtt DashboardFunction.Arn
    Export:
      Name: !Sub '${DashboardName}-function-arn'